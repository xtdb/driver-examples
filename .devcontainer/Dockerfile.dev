# Dockerfile
FROM archlinux:base

# Update system and install essential packages
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
    curl \
    ca-certificates \
    rlwrap \
    sudo \
    fish \
    vi \
    git \
    && pacman -Scc --noconfirm

# Create codespace user
RUN useradd -m -s /bin/bash -u 1000 codespace && \
    echo "codespace ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install mise for the codespace user
USER codespace
WORKDIR /home/codespace

RUN curl https://mise.run | sh && \
    echo 'eval "$(~/.local/bin/mise activate bash)"' >> ~/.bashrc && \
    echo 'eval "$(~/.local/bin/mise activate bash --shims)"' >> ~/.bashrc && \
    mkdir -p ~/.config/fish && \
    echo '~/.local/bin/mise activate fish | source' >> ~/.config/fish/config.fish

# Configure mise to automatically trust the workspace directory
RUN mkdir -p ~/.config/mise && \
    echo '[settings]' > ~/.config/mise/config.toml && \
    echo 'trusted_config_paths = ["/workspaces/driver-examples"]' >> ~/.config/mise/config.toml

# Add mise to PATH for current session
ENV PATH="/home/codespace/.local/bin:${PATH}"

# Copy tool-versions file to install language runtimes
COPY --chown=codespace:codespace .tool-versions /tmp/.tool-versions

# Install language runtimes during build
RUN cd /tmp && \
    ~/.local/bin/mise install && \
    rm /tmp/.tool-versions

# Set the working directory
WORKDIR /workspaces/driver-examples
