# Dockerfile
FROM archlinux:base

# Copy and run shared dependency installation script
COPY .devcontainer/install-system-deps.sh /tmp/install-system-deps.sh
RUN chmod +x /tmp/install-system-deps.sh && \
    /tmp/install-system-deps.sh all && \
    rm /tmp/install-system-deps.sh

# Create codespace user
RUN useradd -m -s /bin/bash -u 1000 codespace && \
    echo "codespace ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install and configure mise for the codespace user
USER codespace
WORKDIR /home/codespace

COPY --chown=codespace:codespace .devcontainer/setup-mise.sh /tmp/setup-mise.sh
RUN chmod +x /tmp/setup-mise.sh && \
    /tmp/setup-mise.sh codespace /workspaces/driver-examples && \
    rm /tmp/setup-mise.sh

# Add mise to PATH for current session
ENV PATH="/home/codespace/.local/bin:${PATH}"

# Copy tool-versions file to install language runtimes
COPY --chown=codespace:codespace .tool-versions /tmp/.tool-versions

# Install language runtimes during build
RUN cd /tmp && \
    ~/.local/bin/mise install && \
    rm /tmp/.tool-versions

# Install language-specific tools (Clojure, Elixir, PHP Composer)
COPY --chown=codespace:codespace .devcontainer/setup-language-tools.sh /tmp/setup-language-tools.sh
RUN chmod +x /tmp/setup-language-tools.sh && \
    /tmp/setup-language-tools.sh all && \
    rm /tmp/setup-language-tools.sh

# Set the working directory
WORKDIR /workspaces/driver-examples
